---
draw:
tags: []
title: redis
date created: 2024-07-10
date modified: 2024-11-12
---
大 key 治理
[秒写回](秒写回)


在 Redis 中出现大 Key（即某个键所存储的数据过于庞大、数据量特别大）会引发一系列问题，例如内存占用过大、网络传输成本过高、阻塞 Redis 主线程导致延迟飙升、数据迁移和扩容困难等。为了更好地治理和优化大 Key，通常需要从数据模型设计、数据分片、访问模式优化、持久化策略与监控告警等多方面入手。以下是较为系统的思路和实践方法：

1. **数据模型优化与设计层面**：
    
    - **提前预防大 Key 的产生**：在业务早期就充分了解数据访问和存储需求，防止将过多数据压缩在单一键下。
    - **数据分片 (Sharding)**：将一个大键的存储数据合理拆分为多个较小的键。例如对一个存储数百万条数据的 List，可以按照一定的 hash 或索引规则切分为多个独立的 list key。
    - **使用更合适的数据结构**：Redis 提供多种数据结构（String、List、Hash、Set、ZSet、HyperLogLog、Stream等），根据数据特征选取合适的数据结构。例如，如果你存放的是类似用户信息键值对，Hash结构的内存利用率更高且访问粒度更细，有利于在后续做拆分。
2. **分层与索引化**：
    
    - **层次化存储**：将原本整合在一个键的数据分为多层结构。上层是一个聚合索引键（比如一个 Hash 表），下层是多个更小的子键，每个子键对应一部分数据。通过索引键来管理和快速定位下层子键。
    - **分批加载与懒加载**：在访问数据时，只在需要时访问相应的子键数据，而不是一口气读取整个大 Key，从而降低单次访问延迟与内存峰值。
3. **数据压缩与序列化策略**：
    
    - **数据压缩**：在存储较大文本或重复模式较多的数据时，可选择对数据进行压缩后存入 Redis（如 gz、lz4 等方式），虽然 Redis 本身不直接提供压缩功能，但可通过应用侧在 set/get 时对数据进行压缩与解压缩处理。
    - **轻量化存储**：若数据是较大对象序列化结果，则可选择更高效的序列化协议（如 MsgPack、Protobuf）减少数据体积。
4. **操作粒度与访问模式优化**：
    
    - **谨慎使用 Keys 操作**：不要使用 `KEYS` 命令来扫描过大键空间，改用 `SCAN` 避免阻塞。
    - **分步读取（Chunking）**：对大数据进行分段读写，每次只处理一部分数据，减少阻塞。
    - **异步删除/逐步淘汰**：在删除大 Key 时采用 `UNLINK`（4.0+） 而不是 `DEL`，以在后台线程异步回收内存，避免阻塞主线程。
5. **监控与告警**：
    
    - **大 Key 监控**：使用 Redis 内置的 `MEMORY USAGE` 命令或外部监控工具（如 RedisInsight、grafana+prometheus 方案）对 Key 大小进行定期采样检查。发现超大 Key 时及时预警和处理。
    - **内存上限控制**：合理设置 `maxmemory` 和淘汰策略，并对特定业务键进行定期巡检，避免 Key 体量无节制增长。
6. **架构与运维层面**：
    
    - **分布式架构与分库分表**：对于超大数据集，可以使用 Redis Cluster，将数据水平拆分到多个分片中，降低单节点大 Key 的风险。
    - **冷热分离**：将不常访问的数据从 Redis 中移出，存入更廉价、更适合长久存储的系统（如 MySQL 或 Cassandra），Redis 只保留热点数据。
    - **定期清理与归档**：对不再需要实时查询的历史数据，定期清理出 Redis，以免形成大 Key。
7. **通过中间层或代理进行治理**：
    
    - **应用侧缓存抽象层**：在应用中加一层缓存访问逻辑，对即将写入 Redis 的数据进行拆分和规则化存储，从源头杜绝大 Key。
    - **数据治理策略与自动化**：建立自动检测大 Key 的运维脚本，一旦发现异常键，自动触发拆分、迁移或清理操作。

综合而言，对 Redis 大 Key 的治理核心思想在于 **事前设计+事中监控+事后优化**，具体手段包括数据结构和存储模式的优化、分片与索引技术、访问模式微调、合适的删除与压缩策略，以及通过增强监控与报警来实现闭环治理。这些手段的有机结合将显著降低由于大 Key 导致的 Redis 性能与可用性问题。


| 平均adr区间   | 0      | (0-5%) | (5%-10%) | (10%-15%) | (15%-20%) | (20%-30%) | (30%-50%) | (>50%) |
| --------- | ------ | ------ | -------- | --------- | --------- | --------- | --------- | ------ |
| 0-99      | 17.94% | 13.55% | 20.85%   | 17.94%    | 11.57%    | 10.06%    | 5.40%     | 2.68%  |
| 100-199   | 5.90%  | 9.61%  | 23.49%   | 23.03%    | 16.83%    | 15.60%    | 4.22%     | 1.32%  |
| 200-299   | 2.12%  | 4.16%  | 18.10%   | 25.03%    | 23.63%    | 22.09%    | 8.22%     | 0.96%  |
| 300-399   | 1.49%  | 2.44%  | 14.16%   | 25.25%    | 25.03%    | 27.10%    | 14.86%    | 1.48%  |
| 400-499   | 1.62%  | 1.79%  | 12.85%   | 24.57%    | 24.54%    | 27.76%    | 17.02%    | 2.84%  |
| 500-599   | 1.46%  | 1.64%  | 11.27%   | 22.30%    | 24.40%    | 30.88%    | 23.51%    | 4.53%  |
| 600-699   | 1.60%  | 1.79%  | 10.64%   | 19.25%    | 23.76%    | 30.87%    | 26.92%    | 4.31%  |
| 700-799   | 1.20%  | 1.49%  | 9.77%    | 17.34%    | 21.14%    | 30.25%    | 28.74%    | 7.28%  |
| 800-899   | 1.22%  | 1.47%  | 8.66%    | 15.25%    | 21.71%    | 31.52%    | 29.58%    | 10.00% |
| 900-999   | 1.10%  | 1.29%  | 7.13%    | 13.14%    | 19.75%    | 31.02%    | 30.05%    | 11.51% |
| 1000-1299 | 0.98%  | 1.30%  | 6.45%    | 10.50%    | 15.28%    | 30.08%    | 30.45%    | 5.97%  |
| 1300-1499 | 0.69%  | 0.95%  | 4.20%    | 8.11%     | 14.46%    | 31.63%    | 33.09%    | 6.88%  |
| 1500-1799 | 0.61%  | 0.81%  | 3.85%    | 7.46%     | 11.16%    | 32.89%    | 35.22%    | 8.60%  |
| 1800-1999 | 0.61%  | 0.79%  | 3.71%    | 7.09%     | 10.48%    | 32.52%    | 35.23%    | 9.58%  |
| 2000+     | 4.29%  | 0.96%  | 2.64%    | 7.46%     | 8.39%     | 34.39%    | 15.27%    | 23.80% |
| 合计        | 5.51%  | 6.28%  | 18.15%   | 23.38%    | 18.87%    | 19.11%    | 8.37%     | 1.32%  |
